<?xml version="1.0" encoding="utf-8"?><?xml-stylesheet type="text/xsl" href="https://www.lazurkin.de/xml/base.min.xml"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>DevOps on Lazurkin</title><link>https://www.lazurkin.de/tags/devops/</link><description>Recent content in DevOps on Lazurkin</description><generator>Hugo -- gohugo.io</generator><language>en-US</language><lastBuildDate>Sun, 26 Jan 2025 15:17:29 +0100</lastBuildDate><atom:link rel="self" href="https://www.lazurkin.de/tags/devops/feed.xml" type="application/rss+xml"/><item><title>Reliable Garden (DevOps tool) on CI</title><link>https://www.lazurkin.de/blog/reliable_garden_on_ci/</link><pubDate>Sun, 26 Jan 2025 15:17:29 +0100</pubDate><guid>https://www.lazurkin.de/blog/reliable_garden_on_ci/</guid><description>&lt;div class="toc">
&lt;nav id="TableOfContents">
&lt;ul>
&lt;li>&lt;a href="#challenge">Challenge&lt;/a>&lt;/li>
&lt;li>&lt;a href="#solution">Solution&lt;/a>&lt;/li>
&lt;li>&lt;a href="#implementation">Implementation&lt;/a>
&lt;ul>
&lt;li>&lt;a href="#1-git-proxy-fake-gitsh">1. Git Proxy (&lt;code>fake-git.sh&lt;/code>)&lt;/a>&lt;/li>
&lt;li>&lt;a href="#2-helm-proxy-fake-helmsh">2. Helm Proxy (&lt;code>fake-helm.sh&lt;/code>)&lt;/a>&lt;/li>
&lt;li>&lt;a href="#3--pipeline-configuration">3. Pipeline Configuration&lt;/a>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;a href="#conclusion">Conclusion&lt;/a>&lt;/li>
&lt;/ul>
&lt;/nav>
&lt;/div>
&lt;p>I worked on a project migrating an existing platform to the cloud. The platform consisted of 20+ services and infrastructure components including databases, message queues, blob storage, and observability tools. It featured an e2e-test suite for functional testing, executed on GitLab CI by spinning up the entire platform using docker-compose and running JUnit tests.&lt;/p>
&lt;p>During migration, we replaced the centralized docker-compose setup with a distributed configuration using &lt;a href="https://github.com/garden-io/garden">Garden&lt;/a> v0.13.&lt;/p>
&lt;!-- more -->
&lt;h2 id="challenge">
&lt;a class="Heading-link u-clickable" href="https://www.lazurkin.de/blog/reliable_garden_on_ci/#challenge">Challenge&lt;/a>
&lt;/h2>
&lt;p>Our e2e testing setup involved a Garden project that:&lt;/p>
&lt;ol>
&lt;li>Pulled projects from different Git repositories&lt;/li>
&lt;li>Started required services in a dedicated Kubernetes(K8S) namespace&lt;/li>
&lt;li>Built docker image with tests suite and executed it inside the same K8S namespace&lt;/li>
&lt;li>Collected results&lt;/li>
&lt;li>Either shut down the application (on success) or kept it running for investigation (on failure)&lt;/li>
&lt;/ol>
&lt;p>While this seemed ideal for Garden, the CI pipeline&amp;rsquo;s deployment stage faced several challenges:&lt;/p>
&lt;ul>
&lt;li>Overloading GitLab with repository pulls&lt;/li>
&lt;li>Overloading the K8S API&lt;/li>
&lt;li>Excessive memory consumption (up to 500MB per Helm process)&lt;/li>
&lt;li>Extended pipeline duration due to repeated Helm dependency updates&lt;/li>
&lt;/ul>
&lt;h2 id="solution">
&lt;a class="Heading-link u-clickable" href="https://www.lazurkin.de/blog/reliable_garden_on_ci/#solution">Solution&lt;/a>
&lt;/h2>
&lt;p>It was obvious that Garden lacks functionality to throttle number of parallel requests as well as retries of operations. Investigation revealed that Garden downloads tools to it&amp;rsquo;s &lt;strong>&lt;code>.garden&lt;/code>&lt;/strong> directory and executes them while parsing their output. I could add missing functionality by creating proxy shell scripts for these tools. I decided to go with retries for Git operations and throttling number of Helm processes. In result I would have the following process:&lt;/p>
&lt;pre class="mermaid">graph TD
A[CI Job Start] --> C[Replace Tools with Proxies]
C --> D[Garden Deploy]
D --> E[Git proxy]
D --> F[Helm proxy]
E -->|Retry Logic| E
F -->|Process Limiting| F
E --> G[Git]
F --> H[Helm]
&lt;/pre>
&lt;h2 id="implementation">
&lt;a class="Heading-link u-clickable" href="https://www.lazurkin.de/blog/reliable_garden_on_ci/#implementation">Implementation&lt;/a>
&lt;/h2>
&lt;h3 id="1-git-proxy-fake-gitsh">
&lt;a class="Heading-link u-clickable" href="https://www.lazurkin.de/blog/reliable_garden_on_ci/#1-git-proxy-fake-gitsh">1. Git Proxy (&lt;code>fake-git.sh&lt;/code>)&lt;/a>
&lt;/h3>
&lt;p>Any debug output is commented, because Garden tries to parse it and fails.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#c00;font-weight:bold">#!/bin/bash
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#c00;font-weight:bold">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#080;font-weight:bold">function&lt;/span> retry {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#038">local&lt;/span> &lt;span style="color:#369">retries&lt;/span>=&lt;span style="color:#369">$1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#038">shift&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#038">local&lt;/span> &lt;span style="color:#369">count&lt;/span>=&lt;span style="color:#00d;font-weight:bold">0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#080;font-weight:bold">until&lt;/span> &lt;span style="color:#d20;background-color:#fff0f0">&amp;#34;&lt;/span>&lt;span style="color:#369">$@&lt;/span>&lt;span style="color:#d20;background-color:#fff0f0">&amp;#34;&lt;/span>; &lt;span style="color:#080;font-weight:bold">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#369">exit&lt;/span>=&lt;span style="color:#369">$?&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#369">wait&lt;/span>=&lt;span style="color:#080;font-weight:bold">$((&lt;/span>&lt;span style="color:#00d;font-weight:bold">2&lt;/span> ** &lt;span style="color:#369">$count&lt;/span>&lt;span style="color:#080;font-weight:bold">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#369">count&lt;/span>=&lt;span style="color:#080;font-weight:bold">$((&lt;/span>&lt;span style="color:#369">$count&lt;/span> + &lt;span style="color:#00d;font-weight:bold">1&lt;/span>&lt;span style="color:#080;font-weight:bold">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#080;font-weight:bold">if&lt;/span> [ &lt;span style="color:#369">$count&lt;/span> -lt &lt;span style="color:#369">$retries&lt;/span> ]; &lt;span style="color:#080;font-weight:bold">then&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#888">#echo &amp;#34;Retry $count/$retries exited $exit, retrying in $wait seconds...&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sleep &lt;span style="color:#369">$wait&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#080;font-weight:bold">else&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#888">#echo &amp;#34;Retry $count/$retries exited $exit, no more retries left.&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#080;font-weight:bold">return&lt;/span> &lt;span style="color:#369">$exit&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#080;font-weight:bold">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#080;font-weight:bold">done&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#080;font-weight:bold">return&lt;/span> &lt;span style="color:#00d;font-weight:bold">0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>retry &lt;span style="color:#00d;font-weight:bold">5&lt;/span> /usr/bin/git &lt;span style="color:#369">$@&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>
&lt;p>The &lt;strong>&lt;code>fake-git.sh&lt;/code>&lt;/strong> script implements exponential backoff retry logic, attempting operations up to 5 times before failing.&lt;/p>
&lt;h3 id="2-helm-proxy-fake-helmsh">
&lt;a class="Heading-link u-clickable" href="https://www.lazurkin.de/blog/reliable_garden_on_ci/#2-helm-proxy-fake-helmsh">2. Helm Proxy (&lt;code>fake-helm.sh&lt;/code>)&lt;/a>
&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#c00;font-weight:bold">#!/bin/bash
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#c00;font-weight:bold">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#888">#echo &amp;#34;In FAKE_HELM! Args: $@&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#888"># Limit concurrent Helm processes to 8 (based on observed memory usage)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#080;font-weight:bold">function&lt;/span> canRun() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#888"># Here helm~ is the original helm downloaded by Garden&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#369">COUNT&lt;/span>=&lt;span style="color:#d20;background-color:#fff0f0">&amp;#34;&lt;/span>&lt;span style="color:#080;font-weight:bold">$(&lt;/span>ps aux | grep helm~ | &lt;span style="color:#04d;background-color:#fff0f0">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#04d;background-color:#fff0f0">&lt;/span> grep -v grep | awk &lt;span style="color:#d20;background-color:#fff0f0">&amp;#39;{print $2}&amp;#39;&lt;/span> | &lt;span style="color:#04d;background-color:#fff0f0">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#04d;background-color:#fff0f0">&lt;/span> wc -l | awk &lt;span style="color:#d20;background-color:#fff0f0">&amp;#39;{$1=$1;print}&amp;#39;&lt;/span>&lt;span style="color:#080;font-weight:bold">)&lt;/span>&lt;span style="color:#d20;background-color:#fff0f0">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#080;font-weight:bold">if&lt;/span> [[ &lt;span style="color:#33b;background-color:#fff0f0">${&lt;/span>&lt;span style="color:#369">COUNT&lt;/span>&lt;span style="color:#33b;background-color:#fff0f0">}&lt;/span> &amp;lt; &lt;span style="color:#00d;font-weight:bold">8&lt;/span> ]]; &lt;span style="color:#080;font-weight:bold">then&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#888">#echo &amp;#34;$(basename $0) is already running.&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#080;font-weight:bold">return&lt;/span> &lt;span style="color:#00d;font-weight:bold">0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#080;font-weight:bold">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#888">#echo &amp;#34;running $(basename $0)&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#080;font-weight:bold">return&lt;/span> &lt;span style="color:#00d;font-weight:bold">1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#888"># Initial random delay (0-9 seconds) to prevent concurrent checks&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>sleep &lt;span style="color:#080;font-weight:bold">$((&lt;/span>RANDOM % &lt;span style="color:#00d;font-weight:bold">10&lt;/span>&lt;span style="color:#080;font-weight:bold">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#080;font-weight:bold">until&lt;/span> canRun
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#080;font-weight:bold">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sleep &lt;span style="color:#00d;font-weight:bold">1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#080;font-weight:bold">done&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#369">helmArgs&lt;/span>=&lt;span style="color:#d20;background-color:#fff0f0">&amp;#34;&lt;/span>&lt;span style="color:#369">$@&lt;/span>&lt;span style="color:#d20;background-color:#fff0f0">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#888"># skip unnecessary package refreshes&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#080;font-weight:bold">if&lt;/span> [[ &lt;span style="color:#369">$helmArgs&lt;/span> == *&lt;span style="color:#d20;background-color:#fff0f0">&amp;#34;dependency update&amp;#34;&lt;/span>* ]]; &lt;span style="color:#080;font-weight:bold">then&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#888">#echo &amp;#34;FAKE_HELM: adding --skip-refresh&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#369">helmArgs&lt;/span>=&lt;span style="color:#d20;background-color:#fff0f0">&amp;#34;&lt;/span>&lt;span style="color:#369">$helmArgs&lt;/span>&lt;span style="color:#d20;background-color:#fff0f0"> --skip-refresh&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#080;font-weight:bold">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#038">exec&lt;/span> &lt;span style="color:#080;font-weight:bold">$(&lt;/span>dirname &lt;span style="color:#d20;background-color:#fff0f0">&amp;#34;&lt;/span>&lt;span style="color:#369">$0&lt;/span>&lt;span style="color:#d20;background-color:#fff0f0">&amp;#34;&lt;/span>&lt;span style="color:#080;font-weight:bold">)&lt;/span>/helm~ &lt;span style="color:#369">$helmArgs&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>
&lt;p>The &lt;strong>&lt;code>fake-helm.sh&lt;/code>&lt;/strong> script:&lt;/p>
&lt;ul>
&lt;li>Limits concurrent Helm processes to 8 (chosen based on our memory constraints: 8 * 500MB = 4GB max usage)&lt;/li>
&lt;li>Skips redundant package refreshes&lt;/li>
&lt;/ul>
&lt;p>Limiting number of concurrent commands is achieved with &lt;strong>&lt;code>canRun&lt;/code>&lt;/strong> function which checks number of currently running &lt;strong>&lt;code>helm&lt;/code>&lt;/strong> processes and returns &lt;code>0&lt;/code> if we can run more processes or &lt;code>1&lt;/code> if limit is already reached. To make it work we also needed to introduce a random delay of command execution, otherwise all processes would simple pass the check. Of course, this logic does not give 100% guarantee of running less than defined limit, but is good enough to throttle parallel execution and make the pipeline stable.&lt;/p>
&lt;p>Finally, to omit unecessary refreshes of packages the &lt;strong>&lt;code>fake-helm.sh&lt;/code>&lt;/strong> adds &lt;strong>&lt;code>--skip-refresh&lt;/code>&lt;/strong> flag to &lt;strong>&lt;code>helm dependency update&lt;/code>&lt;/strong> command, because it could be done only once at the beggining of the pipeline.&lt;/p>
&lt;h3 id="3--pipeline-configuration">
&lt;a class="Heading-link u-clickable" href="https://www.lazurkin.de/blog/reliable_garden_on_ci/#3--pipeline-configuration">3. Pipeline Configuration&lt;/a>
&lt;/h3>
&lt;p>And here is how our deployment job looked like in GitLab CI:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#b06;font-weight:bold">deploy-application&lt;/span>:&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#b06;font-weight:bold">stage&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>deploy&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#b06;font-weight:bold">image&lt;/span>:&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#b06;font-weight:bold">name&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>gardendev/garden:0.13-buster&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#b06;font-weight:bold">pull_policy&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>if-not-present&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#b06;font-weight:bold">resource_limits&lt;/span>:&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#b06;font-weight:bold">memory&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>5Gi&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#b06;font-weight:bold">cpu&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#d20;background-color:#fff0f0">&amp;#34;2&amp;#34;&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#b06;font-weight:bold">timeout&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>1h&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#b06;font-weight:bold">script&lt;/span>:&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#888"># Add extra Helm repositories&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>- garden tools kubernetes.helm -- repo add bitnami https://charts.bitnami.com/bitnami&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#888"># Single repositories update&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>- garden tools kubernetes.helm -- repo update&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>- ./prepare-fake-commands.sh || exit 1&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>- garden deploy -l 4&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#b06;font-weight:bold">artifacts&lt;/span>:&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#b06;font-weight:bold">paths&lt;/span>:&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>- .garden/error.log&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>
&lt;p>The only missing part is &lt;strong>&lt;code>prepare-fake-commands.sh&lt;/code>&lt;/strong> script which replaces original tools with our proxy-scripts:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#c00;font-weight:bold">#!/bin/bash
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#c00;font-weight:bold">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#038">set&lt;/span> -e &lt;span style="color:#888"># Exit on any error&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#369">helmLocation&lt;/span>=&lt;span style="color:#080;font-weight:bold">$(&lt;/span>garden tools kubernetes.helm --get-path&lt;span style="color:#080;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#038">echo&lt;/span> &lt;span style="color:#d20;background-color:#fff0f0">&amp;#34;Garden Helm location: &lt;/span>&lt;span style="color:#369">$helmLocation&lt;/span>&lt;span style="color:#d20;background-color:#fff0f0">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>mv &lt;span style="color:#369">$helmLocation&lt;/span> &lt;span style="color:#d20;background-color:#fff0f0">&amp;#34;&lt;/span>&lt;span style="color:#369">$helmLocation&lt;/span>&lt;span style="color:#d20;background-color:#fff0f0">~&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#038">echo&lt;/span> &lt;span style="color:#d20;background-color:#fff0f0">&amp;#34;Copied original Garden Helm to: &lt;/span>&lt;span style="color:#33b;background-color:#fff0f0">${&lt;/span>&lt;span style="color:#369">helmLocation&lt;/span>&lt;span style="color:#33b;background-color:#fff0f0">}&lt;/span>&lt;span style="color:#d20;background-color:#fff0f0">~&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>cp ./fake-helm.sh &lt;span style="color:#369">$helmLocation&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#038">echo&lt;/span> &lt;span style="color:#d20;background-color:#fff0f0">&amp;#34;Copied fake-helm.sh to: &lt;/span>&lt;span style="color:#33b;background-color:#fff0f0">${&lt;/span>&lt;span style="color:#369">helmLocation&lt;/span>&lt;span style="color:#33b;background-color:#fff0f0">}&lt;/span>&lt;span style="color:#d20;background-color:#fff0f0">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>cp ./fake-git.sh /garden/git
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#038">echo&lt;/span> &lt;span style="color:#d20;background-color:#fff0f0">&amp;#34;Copied fake-git to: /garden/git&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>ln -s &lt;span style="color:#080;font-weight:bold">$(&lt;/span>garden tools kubernetes.kubectl --get-path&lt;span style="color:#080;font-weight:bold">)&lt;/span> /garden/kubectl
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#038">echo&lt;/span> &lt;span style="color:#d20;background-color:#fff0f0">&amp;#34;Created link of garden kubectl to: /garden/kubectl&amp;#34;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>
&lt;h2 id="conclusion">
&lt;a class="Heading-link u-clickable" href="https://www.lazurkin.de/blog/reliable_garden_on_ci/#conclusion">Conclusion&lt;/a>
&lt;/h2>
&lt;p>This is a story with happy end. My improvements significantly enhanced pipeline reliability while managing resource consumption effectively. However, it highlights an important lesson: modern tools, despite their promise, may not be fully mature. When applying them to your specific use case, be prepared to:&lt;/p>
&lt;ul>
&lt;li>Understand the tool&amp;rsquo;s internal workings&lt;/li>
&lt;li>Create workarounds that respect the tool&amp;rsquo;s design&lt;/li>
&lt;li>Monitor and measure the impact of your solutions&lt;/li>
&lt;/ul>
&lt;p>Remember: sometimes the simplest solution - like a shell script wrapper - can bridge the gap between a tool&amp;rsquo;s current capabilities and your production needs.&lt;/p></description></item><item><title>Modern CI antipattern</title><link>https://www.lazurkin.de/blog/modern_ci_antipattern/</link><pubDate>Thu, 07 Mar 2024 00:00:00 +0000</pubDate><guid>https://www.lazurkin.de/blog/modern_ci_antipattern/</guid><description>&lt;p>Have you ever used modern CI platforms like &lt;a href="https://docs.gitlab.com/ee/ci/">GitLab CI&lt;/a> or &lt;a href="https://docs.github.com/en/actions">GitHub Actions&lt;/a>?&lt;/p>
&lt;p>Then you know that usually pipeline configuration comes from &lt;a href="https://yaml.org/">YAML&lt;/a> files. In most cases, this is not a single YAML but the whole jungle of files with references, inheritance, inlined shell scripts, and other disgusting things. I do see it as an antipattern people should avoid. Let&amp;rsquo;s see why.&lt;/p>
&lt;div class="toc">
&lt;nav id="TableOfContents">
&lt;ul>
&lt;li>&lt;a href="#case-study">Case study&lt;/a>&lt;/li>
&lt;li>&lt;a href="#whats-wrong-with-it">What&amp;rsquo;s wrong with it?&lt;/a>&lt;/li>
&lt;li>&lt;a href="#what-to-do">What to do?&lt;/a>&lt;/li>
&lt;/ul>
&lt;/nav>
&lt;/div>
&lt;h2 id="case-study">
&lt;a class="Heading-link u-clickable" href="https://www.lazurkin.de/blog/modern_ci_antipattern/#case-study">Case study&lt;/a>
&lt;/h2>
&lt;p>This site you are currently reading is a static site generated with &lt;a href="https://gohugo.io/">Hugo&lt;/a> and hosted on &lt;a href="https://pages.github.com/">GitHub Pages&lt;/a>. One option to publish the site to GitHub Pages is to use GitHub Actions which I considered.&lt;/p>
&lt;p>So let&amp;rsquo;s take a look at the proposed &lt;a href="https://gohugo.io/hosting-and-deployment/hosting-on-github/">Deploy Hugo site to GitHub Pages&lt;/a> pipeline:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#888"># Sample workflow for building and deploying a Hugo site to GitHub Pages&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb">&lt;/span>&lt;span style="color:#b06;font-weight:bold">name&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>Deploy Hugo site to Pages&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb">&lt;/span>&lt;span style="color:#b06;font-weight:bold">on&lt;/span>:&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#888"># Runs on pushes targeting the default branch&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#b06;font-weight:bold">push&lt;/span>:&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#b06;font-weight:bold">branches&lt;/span>:&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>- main&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#888"># Allows you to run this workflow manually from the Actions tab&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#b06;font-weight:bold">workflow_dispatch&lt;/span>:&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb">&lt;/span>&lt;span style="color:#888"># Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb">&lt;/span>&lt;span style="color:#b06;font-weight:bold">permissions&lt;/span>:&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#b06;font-weight:bold">contents&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>read&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#b06;font-weight:bold">pages&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>write&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#b06;font-weight:bold">id-token&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>write&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb">&lt;/span>&lt;span style="color:#888"># Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb">&lt;/span>&lt;span style="color:#888"># However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb">&lt;/span>&lt;span style="color:#b06;font-weight:bold">concurrency&lt;/span>:&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#b06;font-weight:bold">group&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#d20;background-color:#fff0f0">&amp;#34;pages&amp;#34;&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#b06;font-weight:bold">cancel-in-progress&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#080;font-weight:bold">false&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb">&lt;/span>&lt;span style="color:#888"># Default to bash&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb">&lt;/span>&lt;span style="color:#b06;font-weight:bold">defaults&lt;/span>:&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#b06;font-weight:bold">run&lt;/span>:&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#b06;font-weight:bold">shell&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>bash&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb">&lt;/span>&lt;span style="color:#b06;font-weight:bold">jobs&lt;/span>:&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#888"># Build job&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#b06;font-weight:bold">build&lt;/span>:&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#b06;font-weight:bold">runs-on&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>ubuntu-latest&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#b06;font-weight:bold">env&lt;/span>:&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#b06;font-weight:bold">HUGO_VERSION&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#00d;font-weight:bold">0.123.0&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#b06;font-weight:bold">steps&lt;/span>:&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>- &lt;span style="color:#b06;font-weight:bold">name&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>Install Hugo CLI&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#b06;font-weight:bold">run&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>|&lt;span style="color:#d20;background-color:#fff0f0">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#d20;background-color:#fff0f0"> wget -O ${{ runner.temp }}/hugo.deb \
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#d20;background-color:#fff0f0"> https://github.com/gohugoio/hugo/releases/download/v${HUGO_VERSION}/hugo_extended_${HUGO_VERSION}_linux-amd64.deb \
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#d20;background-color:#fff0f0"> &amp;amp;&amp;amp; sudo dpkg -i ${{ runner.temp }}/hugo.deb&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>- &lt;span style="color:#b06;font-weight:bold">name&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>Install Dart Sass&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#b06;font-weight:bold">run&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>sudo snap install dart-sass&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>- &lt;span style="color:#b06;font-weight:bold">name&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>Checkout&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#b06;font-weight:bold">uses&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>actions/checkout@v4&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#b06;font-weight:bold">with&lt;/span>:&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#b06;font-weight:bold">submodules&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>recursive&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#b06;font-weight:bold">fetch-depth&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#00d;font-weight:bold">0&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>- &lt;span style="color:#b06;font-weight:bold">name&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>Setup Pages&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#b06;font-weight:bold">id&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>pages&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#b06;font-weight:bold">uses&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>actions/configure-pages@v4&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>- &lt;span style="color:#b06;font-weight:bold">name&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>Install Node.js dependencies&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#b06;font-weight:bold">run&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#d20;background-color:#fff0f0">&amp;#34;[[ -f package-lock.json || -f npm-shrinkwrap.json ]] &amp;amp;&amp;amp; npm ci || true&amp;#34;&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>- &lt;span style="color:#b06;font-weight:bold">name&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>Build with Hugo&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#b06;font-weight:bold">env&lt;/span>:&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#888"># For maximum backward compatibility with Hugo modules&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#b06;font-weight:bold">HUGO_ENVIRONMENT&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>production&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#b06;font-weight:bold">HUGO_ENV&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>production&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#b06;font-weight:bold">run&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>|&lt;span style="color:#d20;background-color:#fff0f0">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#d20;background-color:#fff0f0"> hugo \
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#d20;background-color:#fff0f0"> --gc \
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#d20;background-color:#fff0f0"> --minify \
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#d20;background-color:#fff0f0"> --baseURL &amp;#34;${{ steps.pages.outputs.base_url }}/&amp;#34;&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>- &lt;span style="color:#b06;font-weight:bold">name&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>Upload artifact&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#b06;font-weight:bold">uses&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>actions/upload-pages-artifact@v2&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#b06;font-weight:bold">with&lt;/span>:&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#b06;font-weight:bold">path&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>./public&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#888"># Deployment job&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#b06;font-weight:bold">deploy&lt;/span>:&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#b06;font-weight:bold">environment&lt;/span>:&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#b06;font-weight:bold">name&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>github-pages&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#b06;font-weight:bold">url&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>${{ steps.deployment.outputs.page_url }}&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#b06;font-weight:bold">runs-on&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>ubuntu-latest&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#b06;font-weight:bold">needs&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>build&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#b06;font-weight:bold">steps&lt;/span>:&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>- &lt;span style="color:#b06;font-weight:bold">name&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>Deploy to GitHub Pages&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#b06;font-weight:bold">id&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>deployment&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#b06;font-weight:bold">uses&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>actions/deploy-pages@v3&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>
&lt;p>Just to generate a static site and make it available on GitHub Pages you would need:&lt;/p>
&lt;ul>
&lt;li>
&lt;p>80 lines of &lt;a href="https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions">GitHub Actions YAML DSL&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Inline shell scripts which should be the easiest part here
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">&lt;code class="language-sh" data-lang="sh">&lt;span style="display:flex;">&lt;span>wget -O &lt;span style="color:#33b;background-color:#fff0f0">${&lt;/span>{ runner.temp &lt;span style="color:#33b;background-color:#fff0f0">}&lt;/span>}/hugo.deb &lt;span style="color:#04d;background-color:#fff0f0">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#04d;background-color:#fff0f0">&lt;/span> https://github.com/gohugoio/hugo/releases/download/v&lt;span style="color:#33b;background-color:#fff0f0">${&lt;/span>&lt;span style="color:#369">HUGO_VERSION&lt;/span>&lt;span style="color:#33b;background-color:#fff0f0">}&lt;/span>/hugo_extended_&lt;span style="color:#33b;background-color:#fff0f0">${&lt;/span>&lt;span style="color:#369">HUGO_VERSION&lt;/span>&lt;span style="color:#33b;background-color:#fff0f0">}&lt;/span>_linux-amd64.deb &lt;span style="color:#04d;background-color:#fff0f0">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#04d;background-color:#fff0f0">&lt;/span> &amp;amp;&amp;amp; sudo dpkg -i &lt;span style="color:#33b;background-color:#fff0f0">${&lt;/span>{ runner.temp &lt;span style="color:#33b;background-color:#fff0f0">}&lt;/span>}/hugo.deb
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>...
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>[[ -f package-lock.json || -f npm-shrinkwrap.json ]] &amp;amp;&amp;amp; npm ci || &lt;span style="color:#038">true&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>...
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>hugo &lt;span style="color:#04d;background-color:#fff0f0">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#04d;background-color:#fff0f0">&lt;/span> --gc &lt;span style="color:#04d;background-color:#fff0f0">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#04d;background-color:#fff0f0">&lt;/span> --minify &lt;span style="color:#04d;background-color:#fff0f0">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#04d;background-color:#fff0f0">&lt;/span> --baseURL &lt;span style="color:#d20;background-color:#fff0f0">&amp;#34;&lt;/span>&lt;span style="color:#33b;background-color:#fff0f0">${&lt;/span>{ steps.pages.outputs.base_url &lt;span style="color:#33b;background-color:#fff0f0">}&lt;/span>&lt;span style="color:#d20;background-color:#fff0f0">}/&amp;#34;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Magic values (the most problematic part in my opinion)
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#b06;font-weight:bold">uses&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>actions/configure-pages@v4&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb">&lt;/span>&lt;span style="color:#b06;font-weight:bold">...&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb">&lt;/span>&lt;span style="color:#b06;font-weight:bold">uses&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>actions/upload-pages-artifact@v2&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb">&lt;/span>&lt;span style="color:#b06;font-weight:bold">...&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb">&lt;/span>&lt;span style="color:#b06;font-weight:bold">uses&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>actions/deploy-pages@v3&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb">&lt;/span>```&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>These magic values are GitHub Actions carefully prepared by the GitHub Actions Team for your convenience.&lt;/p>
&lt;p>For example &lt;a href="https://github.com/actions/upload-pages-artifact/blob/v2/action.yml">actions/upload-pages-artifact@v2&lt;/a> is a 71 lines YAML file, while
&lt;a href="https://github.com/actions/configure-pages/tree/v4">actions/configure-pages@v4&lt;/a> and &lt;a href="https://github.com/actions/deploy-pages/tree/v3">actions/deploy-pages@v3&lt;/a> are 2 complex JavaScript based actions. If not getting deep into implementation details you at least would need to understand how to use these building blocks, their input and output parameters. And it is not as straightforward as with any programming language you used to work.&lt;/p>
&lt;h2 id="whats-wrong-with-it">
&lt;a class="Heading-link u-clickable" href="https://www.lazurkin.de/blog/modern_ci_antipattern/#whats-wrong-with-it">What&amp;rsquo;s wrong with it?&lt;/a>
&lt;/h2>
&lt;p>The example above is a very simple task - publishing a static site. In enterprise development, CI pipelines are way more complicated with testing, linting, versioning, and other activities. And if you fall into a trap of all these convenient actions and templates, you start including them in your project, configuring them with parameters for your needs, inheriting them, producing your own actions and templates, and spawning tons of interconnected YAML files. It is a project in itself that requires heavy maintenance. In big companies there even could be a dedicated team to support CI setup.&lt;/p>
&lt;p>Here are the disadvantages of this technique:&lt;/p>
&lt;ul>
&lt;li>It is not possible to run CI scripts locally. After making a change to a CI script you can verify it only on a CI platform&lt;/li>
&lt;li>As a result, there are different approaches to local development and CI&lt;/li>
&lt;li>CI scripts require heavy maintenance, sometimes even consuming the capacity of a whole team&lt;/li>
&lt;li>Most likely pipelines will consist of many steps, running in different containers, consuming a lot of resources, and taking a lot of time&lt;/li>
&lt;li>If there is a dedicated team to maintain CI scripts then:
&lt;ul>
&lt;li>they will produce generic scripts to meet the needs of all teams even more increasing the complexity&lt;/li>
&lt;li>developers will be detached from all these scripts caring only about the &amp;ldquo;green&amp;rdquo; pipeline without trying to understand the details&lt;/li>
&lt;li>I&amp;rsquo;ve seen a case when a pipeline was &amp;ldquo;green&amp;rdquo; and both parties thought that everything is fine, although it was not&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>A complex CI setup results in a CI platform vendor lock-in&lt;/li>
&lt;/ul>
&lt;h2 id="what-to-do">
&lt;a class="Heading-link u-clickable" href="https://www.lazurkin.de/blog/modern_ci_antipattern/#what-to-do">What to do?&lt;/a>
&lt;/h2>
&lt;p>Having already a list of problems we need to do the opposite to avoid them.&lt;/p>
&lt;ul>
&lt;li>CI has to be based on something that developers are not only able to run locally but do regularly. So it has to be part of building tooling&lt;/li>
&lt;li>CI scripts have to be a thin layer to run your regular build tools only passing needed configuration&lt;/li>
&lt;li>Don&amp;rsquo;t build generic solutions on CI. Like tests, CI has to be plain and straightforward&lt;/li>
&lt;li>Keep CI scripts as abstract as possible delegating all details to the project you&amp;rsquo;re building&lt;/li>
&lt;li>Don&amp;rsquo;t prepare an environment for CI in your CI scripts. Instead, prepare it in advance&lt;/li>
&lt;li>Developers have to be responsible for CI and not a dedicated team that knows how to do it better&lt;/li>
&lt;/ul>
&lt;p>An ideal CI pipeline definition would be:
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#b06;font-weight:bold">jobs&lt;/span>:&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#b06;font-weight:bold">build&lt;/span>:&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#b06;font-weight:bold">runs-on&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>prebuilt-docker-image-for-ci&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#b06;font-weight:bold">steps&lt;/span>:&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>- &lt;span style="color:#b06;font-weight:bold">name&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>Build&lt;span style="color:#bbb">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#b06;font-weight:bold">run&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>make build&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/p>
&lt;p>First of all, you prepare an environment for your job in advance - &lt;code>prebuilt-docker-image-for-ci&lt;/code>. And the second you hide all details in a &lt;a href="https://www.gnu.org/software/make/manual/make.html">Makefile&lt;/a>. That&amp;rsquo;s it! You easily can port this setup to any CI platform and any project can be adapted to this script.&lt;/p>
&lt;p>Yes, in this case, you won&amp;rsquo;t have a fancy pipeline diagram and to understand what failed you need to look into logs, but it is the most &lt;strong>efficient&lt;/strong> and &lt;strong>natural&lt;/strong> approach. An error message from the log can be attached to the failed build notification, so you don&amp;rsquo;t even need to look at the diagram. But if the industry needs these diagrams then I&amp;rsquo;d say even more - CI platforms have to be able to understand the output of all popular build tools and visualize pipelines instead of forcing us to adapt to them.&lt;/p>
&lt;p>Of course, the ideal cannot be achieved in every case, but at least you know another perspective and can find a balance.&lt;/p>
&lt;p>Let&amp;rsquo;s not be fooled by the sham convenience of modern CI platforms and keep things simple.&lt;/p></description></item></channel></rss>